<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Idea Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="style.css" />
  <style>
    .card-text.clamp-2 {
      overflow: hidden;
      display: box;
      line-clamp: 2;
      box-orient: vertical;
      white-space: normal;
    }
    .card {
      cursor: pointer;
      position: relative;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="alert alert-warning text-center py-2 px-3 small compact-alert mb-3" role="alert">
      ⚠️ Ideas are <strong>temporarily stored</strong> and may be <strong>refreshed on server restart</strong>.
    </div>

    <div class="mb-3">
      <h5 id="welcomeMessage" class="text-primary fw-semibold"></h5>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Idea Dashboard</h2>
      <div>
        <a href="add-idea.html" class="btn btn-success me-2">+ Add New</a>
        <button id="logoutBtn" class="btn btn-outline-danger">Logout</button>
      </div>
    </div>

    <div id="ideaList" class="row g-4"></div>
    <div class="d-flex justify-content-center mt-4" id="paginationControls"></div>
  </div>

  <!-- Idea Details Modal -->
  <div class="modal fade" id="ideaModal" tabindex="-1" aria-labelledby="ideaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ideaModalLabel">Idea Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h5 id="modalTitle"></h5>
          <p id="modalDescription"></p>
          <p><strong>Category:</strong> <span id="modalCategory"></span></p>
          <p><strong>Impact:</strong> <span id="modalImpact"></span></p>
          <p class="text-muted">
            Author: <span id="modalAuthor"></span><br/>
            <small class="text-secondary">Submitted: <span id="modalDate"></span></small>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback/Confirmation Modal -->
  <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="feedbackModalLabel">Notification</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="feedbackModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="modalOkButton" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const username = localStorage.getItem("username") || "Guest";

let knownUsers = JSON.parse(localStorage.getItem("knownUsers")) || [];

let userNumber;
if (!knownUsers.includes(username)) {
  knownUsers.push(username);
  localStorage.setItem("knownUsers", JSON.stringify(knownUsers));
}

userNumber = knownUsers.indexOf(username) + 1;
localStorage.setItem("userNumber", userNumber);


      const welcomeMessage = `Hey ${username}, <br><br>You are the ${userNumber}${getOrdinalSuffix(userNumber)} user here who may log a life-changing idea. Go ahead!!!`;
      document.getElementById("welcomeMessage").innerHTML = welcomeMessage;

      function getOrdinalSuffix(n) {
        const num = parseInt(n, 10);
        if (isNaN(num)) return "";
        const j = num % 10, k = num % 100;
        if (j === 1 && k !== 11) return "st";
        if (j === 2 && k !== 12) return "nd";
        if (j === 3 && k !== 13) return "rd";
        return "th";
      }

      const isLoggedIn = localStorage.getItem("loggedIn");
      if (!isLoggedIn) {
        window.location.href = "index.html";
        return;
      }

      const API_BASE_URL = window.location.hostname === "localhost"
        ? "http://localhost:5000"
        : "https://idea-portal-1.onrender.com";

      const ideaListContainer = document.getElementById("ideaList");
      const paginationControls = document.getElementById("paginationControls");

      const ITEMS_PER_PAGE = 6;
      let currentPage = 1;
      let ideas = [];

      const feedbackModalElem = document.getElementById('feedbackModal');
      const feedbackModal = new bootstrap.Modal(feedbackModalElem);
      const feedbackModalBody = document.getElementById('feedbackModalBody');
      const feedbackModalTitle = document.getElementById('feedbackModalLabel');
      const modalOkButton = document.getElementById('modalOkButton');

      // --- MODAL HELPERS ---
      function showModal(message, callback = null, disableOk = false, title = "Notification") {
        feedbackModalTitle.textContent = title;
        feedbackModalBody.textContent = message;
        modalOkButton.disabled = !!disableOk;

        modalOkButton.onclick = () => {
          feedbackModal.hide();
          if (callback) callback();
        };

        feedbackModal.show();
      }

      function showConfirm(message) {
        return new Promise((resolve) => {
          feedbackModalTitle.textContent = "Confirmation";
          feedbackModalBody.textContent = message;
          modalOkButton.textContent = "Yes";

          let cancelBtn = document.getElementById("cancelConfirmBtn");
          if (!cancelBtn) {
            cancelBtn = document.createElement("button");
            cancelBtn.id = "cancelConfirmBtn";
            cancelBtn.className = "btn btn-secondary";
            cancelBtn.textContent = "Cancel";
            cancelBtn.setAttribute("type", "button");
            cancelBtn.setAttribute("data-bs-dismiss", "modal");
            modalOkButton.parentElement.insertBefore(cancelBtn, modalOkButton);
          }

          const cleanup = () => {
            feedbackModal.hide();
            modalOkButton.textContent = "OK";
            modalOkButton.onclick = null;
            cancelBtn.remove();
            setTimeout(() => {
              document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
              document.body.classList.remove("modal-open");
              document.body.style = '';
            }, 200);
          };

          modalOkButton.onclick = () => {
            cleanup();
            resolve(true);
          };

          cancelBtn.onclick = () => {
            cleanup();
            resolve(false);
          };

          feedbackModal.show();
        });
      }

      // --- RENDER FUNCTIONS ---
      function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString(undefined, {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }

      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        paginationControls.innerHTML = '';
        if (totalPages <= 1) return;

        const prevBtn = document.createElement("button");
        prevBtn.className = `btn btn-sm btn-outline-primary mx-1`;
        prevBtn.innerHTML = `<i class="bi bi-chevron-left"></i>`;
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            renderIdeas();
            renderPagination(ideas.length);
          }
        });
        paginationControls.appendChild(prevBtn);

        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement("button");
          btn.className = `btn btn-sm btn-outline-primary mx-1 ${i === currentPage ? 'active' : ''}`;
          btn.textContent = i;
          btn.addEventListener("click", () => {
            currentPage = i;
            renderIdeas();
            renderPagination(ideas.length);
          });
          paginationControls.appendChild(btn);
        }

        const nextBtn = document.createElement("button");
        nextBtn.className = `btn btn-sm btn-outline-primary mx-1`;
        nextBtn.innerHTML = `<i class="bi bi-chevron-right"></i>`;
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener("click", () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderIdeas();
            renderPagination(ideas.length);
          }
        });
        paginationControls.appendChild(nextBtn);
      }

      function renderIdeas() {
        ideaListContainer.innerHTML = "";

        if (!Array.isArray(ideas) || ideas.length === 0) {
          ideaListContainer.innerHTML = `
            <div class="col-12">
              <div class="alert alert-info text-center">No ideas submitted yet.</div>
            </div>
          `;
          return;
        }

        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const paginatedIdeas = ideas.slice(start, start + ITEMS_PER_PAGE);

        paginatedIdeas.forEach(idea => {
          const col = document.createElement("div");
          col.className = "col-md-6 col-lg-4";

          col.innerHTML = `
            <div class="card shadow-sm" tabindex="0" role="button">
              <div class="card-body d-flex flex-column position-relative">
                <h5 class="card-title">${idea.title}</h5>
                <p class="card-text flex-grow-1 clamp-2">${idea.description}</p>
                <p class="mb-1"><strong>Category:</strong> ${idea.category || 'N/A'}</p>
                <p class="mb-1"><strong>Impact:</strong> ${idea.impact || 'N/A'}</p>
                <p class="text-muted mt-3 mb-2">
                  Author: ${idea.author || 'Unknown'}<br/>
                  <small class="text-secondary">Submitted: ${formatDate(idea.date_submitted)}</small>
                </p>
                <button class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2 delete-btn" data-id="${idea.id}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          `;

          col.querySelector(".card").addEventListener("click", (e) => {
            if (e.target.closest(".delete-btn")) return;
            showIdeaModal(idea);
          });

          ideaListContainer.appendChild(col);
        });
      }

      function showIdeaModal(idea) {
        document.getElementById("modalTitle").textContent = idea.title;
        document.getElementById("modalDescription").textContent = idea.description;
        document.getElementById("modalCategory").textContent = idea.category || 'N/A';
        document.getElementById("modalImpact").textContent = idea.impact || 'N/A';
        document.getElementById("modalAuthor").textContent = idea.author || 'Unknown';
        document.getElementById("modalDate").textContent = formatDate(idea.date_submitted);
        new bootstrap.Modal(document.getElementById("ideaModal")).show();
      }

      async function loadIdeas() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/all-ideas`);
          if (!response.ok) throw new Error("Failed to load ideas.");

          ideas = await response.json();
          currentPage = 1;
          renderIdeas();
          renderPagination(ideas.length);

        } catch (error) {
          console.error("Error fetching ideas:", error);
          ideaListContainer.innerHTML = `
            <div class="col-12">
              <div class="alert alert-danger text-center">
                Failed to load ideas. Please try again later.
              </div>
            </div>
          `;
          showModal("Failed to load ideas. Please check your server or try again later.", null, false, "Error");
        }
      }

      ideaListContainer.addEventListener("click", async (e) => {
        const deleteBtn = e.target.closest(".delete-btn");
        if (!deleteBtn) return;

        e.stopPropagation();
        const ideaId = deleteBtn.getAttribute("data-id");
        const username = localStorage.getItem("username");
        const isSuperadmin = localStorage.getItem("isSuperadmin") === "true";

        if (!username) {
          showModal("You must be logged in to delete ideas.", null, false, "Error");
          return;
        }

        if (!isSuperadmin) {
          showModal("Only the superadmin can delete ideas.", null, false, "Error");
          return;
        }

        const confirmed = await showConfirm("Are you sure you want to delete this idea?");
        if (!confirmed) return;

        showModal("Deleting idea...", null, true, "Notification");

        try {
          const res = await fetch(`${API_BASE_URL}/api/delete-idea/${ideaId}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username })
          });

          const data = await res.json();
          if (res.ok) {
            showModal("Idea deleted successfully!", loadIdeas, false, "Success");
          } else {
            showModal(data.error || "Failed to delete idea.", null, false, "Error");
          }

        } catch (err) {
          console.error("Delete failed:", err);
          showModal("An error occurred. Please try again.", null, false, "Error");
        }
      });

      await loadIdeas();

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("loggedIn");
        localStorage.removeItem("username");
        localStorage.removeItem("isSuperadmin");
        window.location.href = "index.html";
      });

      // Global safeguard: remove backdrops after modal closes
      document.addEventListener('hidden.bs.modal', () => {
        document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
        document.body.classList.remove("modal-open");
        document.body.style = '';
      });
    });
  </script>
</body>
</html>
