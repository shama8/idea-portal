<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Idea Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Clamp description to 2 lines with ellipsis */
    .card-text.clamp-2 {
      overflow: hidden;
      display: -webkit-box;
      line-clamp: 2;
      box-orient: vertical;
      white-space: normal; /* allow wrapping */
    }
    /* Make cursor pointer on card */
    .card {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Idea Dashboard</h2>
      <div>
        <a href="add-idea.html" class="btn btn-success me-2">+ Add New</a>
        <button id="logoutBtn" class="btn btn-outline-danger">Logout</button>
      </div>
    </div>

    <div id="ideaList" class="row g-4">
      <!-- Dynamic idea cards will be inserted here -->
    </div>

    <!-- PAGINATION CONTROLS -->
    <div class="d-flex justify-content-center mt-4" id="paginationControls">
      <!-- Buttons go here -->
    </div>
  </div>

  <!-- Modal for full idea -->
  <div class="modal fade" id="ideaModal" tabindex="-1" aria-labelledby="ideaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ideaModalLabel">Idea Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h5 id="modalTitle"></h5>
          <p id="modalDescription"></p>
          <p><strong>Category:</strong> <span id="modalCategory"></span></p>
          <p><strong>Impact:</strong> <span id="modalImpact"></span></p>
          <p class="text-muted">
            Author: <span id="modalAuthor"></span><br/>
            <small class="text-secondary">Submitted: <span id="modalDate"></span></small>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const isLoggedIn = localStorage.getItem("loggedIn");
      if (!isLoggedIn) {
        window.location.href = "index.html";
        return;
      }

      const API_BASE_URL = window.location.hostname === "localhost"
        ? "http://localhost:5000"
        : "https://idea-portal-1.onrender.com";

      const ideaListContainer = document.getElementById("ideaList");
      const paginationControls = document.getElementById("paginationControls");

      const ITEMS_PER_PAGE = 6;
      let currentPage = 1;
      let ideas = [];

      function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString(undefined, {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }

      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        paginationControls.innerHTML = '';

        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement("button");
          btn.className = `btn btn-sm btn-outline-primary mx-1 ${i === currentPage ? 'active' : ''}`;
          btn.textContent = i;
          btn.addEventListener("click", () => {
            currentPage = i;
            renderIdeas();
            renderPagination(ideas.length);
          });
          paginationControls.appendChild(btn);
        }
      }

      function renderIdeas() {
        ideaListContainer.innerHTML = "";

        if (!Array.isArray(ideas) || ideas.length === 0) {
          ideaListContainer.innerHTML = `
            <div class="col-12">
              <div class="alert alert-info text-center">No ideas submitted yet.</div>
            </div>
          `;
          return;
        }

        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const paginatedIdeas = ideas.slice(start, start + ITEMS_PER_PAGE);

        paginatedIdeas.forEach(idea => {
          const col = document.createElement("div");
          col.className = "col-md-6 col-lg-4";

          col.innerHTML = `
            <div class="card shadow-sm h-100" tabindex="0" role="button" aria-pressed="false" aria-label="View details of idea titled ${idea.title}">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${idea.title}</h5>
                <p class="card-text flex-grow-1 clamp-2">${idea.description}</p>
                <p class="mb-1"><strong>Category:</strong> ${idea.category || 'N/A'}</p>
                <p class="mb-1"><strong>Impact:</strong> ${idea.impact || 'N/A'}</p>
                <p class="text-muted mt-3 mb-0">
                  Author: ${idea.author || 'Unknown'}<br/>
                  <small class="text-secondary">Submitted: ${formatDate(idea.date_submitted)}</small>
                </p>
              </div>
            </div>
          `;

          // Add click listener to show modal
          col.querySelector(".card").addEventListener("click", () => {
            showIdeaModal(idea);
          });

          ideaListContainer.appendChild(col);
        });
      }

      function showIdeaModal(idea) {
        const modalTitle = document.getElementById("modalTitle");
        const modalDescription = document.getElementById("modalDescription");
        const modalCategory = document.getElementById("modalCategory");
        const modalImpact = document.getElementById("modalImpact");
        const modalAuthor = document.getElementById("modalAuthor");
        const modalDate = document.getElementById("modalDate");

        modalTitle.textContent = idea.title;
        modalDescription.textContent = idea.description;
        modalCategory.textContent = idea.category || 'N/A';
        modalImpact.textContent = idea.impact || 'N/A';
        modalAuthor.textContent = idea.author || 'Unknown';
        modalDate.textContent = formatDate(idea.date_submitted);

        const ideaModal = new bootstrap.Modal(document.getElementById("ideaModal"));
        ideaModal.show();
      }

      async function loadIdeas() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/all-ideas`);
          if (!response.ok) throw new Error("Failed to load ideas.");

          ideas = await response.json();
          currentPage = 1;
          renderIdeas();
          renderPagination(ideas.length);

        } catch (error) {
          console.error("Error fetching ideas:", error);
          ideaListContainer.innerHTML = `
            <div class="col-12">
              <div class="alert alert-danger text-center">
                Failed to load ideas. Please try again later.
              </div>
            </div>
          `;
        }
      }

      await loadIdeas();

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("loggedIn");
        localStorage.removeItem("username");
        window.location.href = "index.html";
      });
    });
  </script>
</body>
</html>
